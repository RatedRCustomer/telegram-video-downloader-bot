services:
  telegram-bot:
    build: ./bot
    container_name: telegram-video-bot
    restart: unless-stopped
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - YT_DLP_API_URL=http://yt-dlp-api:8081
      - MAX_FILE_SIZE=50000000
    volumes:
      - ./downloads:/downloads:rw
      - ./logs:/app/logs:rw
    networks:
      - bot-network
    depends_on:
      - yt-dlp-api
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M

  yt-dlp-api:
    build: ./yt-dlp-service
    container_name: telegram-yt-dlp-api
    restart: unless-stopped
    ports:
      - "8081:8081"
    volumes:
      - ./downloads:/downloads:rw
    networks:
      - bot-network
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.5'
        reservations:
          memory: 512M

  cleanup-service:
    image: alpine:latest
    container_name: telegram-cleanup
    restart: unless-stopped
    volumes:
      - ./downloads:/downloads:rw
      - ./logs:/logs:rw
    command: >
      sh -c '
      while true; do
        echo "ðŸ§¹ [$(date)] Starting cleanup..."
        
        find /downloads -type f -name "*.mp4" -mmin +120 -delete
        find /downloads -type f -name "*.mp3" -mmin +120 -delete
        find /downloads -type f -name "*.webm" -mmin +120 -delete
        find /downloads -type f -name "*.jpg" -mmin +120 -delete
        
        if [ -f /logs/bot.log ]; then
          tail -n 1000 /logs/bot.log > /logs/bot.log.tmp
          mv /logs/bot.log.tmp /logs/bot.log
        fi
        
        echo "ðŸ“Š Downloads folder: $(du -sh /downloads | cut -f1)"
        echo "âœ… Cleanup completed"
        
        sleep 1800
      done
      '
    networks:
      - bot-network
    deploy:
      resources:
        limits:
          memory: 32M

networks:
  bot-network:
    driver: bridge
